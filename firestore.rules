rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users can only read their own data
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Carwashes can be read by anyone (for the public list)
    // Write access is restricted to the owner
    match /carwashes/{carwashId} {
      allow read: if true;
      allow write: if request.auth.uid == resource.data.ownerId;
    }
    
    // Subcollections of carwashes can only be written to by the carwash owner
    match /carwashes/{carwashId}/{document=**} {
       allow write: if get(/databases/$(database)/documents/carwashes/$(carwashId)).data.ownerId == request.auth.uid;
    }

    // Regular users can read jobs that belong to them
    match /carwashes/{carwashId}/jobs/{jobId} {
        allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.phoneNumber == resource.data.clientPhoneNumber;
    }

    // Admins can manage their own data and global settings
    match /superadmins/{superadminId} {
        allow read, write: if request.auth.uid == superadminId;
    }
    match /settings/global {
        allow read, write: if exists(/databases/$(database)/documents/superadmins/$(request.auth.uid));
    }
    
    // Mail is write-only for authenticated users, no reads
    match /mail/{mailId} {
        allow read: if false;
        allow write: if request.auth != null;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
